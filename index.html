<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>治療費シミュレーター</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: #f8fafc;
            /* Slate 50 */
            color: #334155;
            /* Slate 700 */
        }

        .chic-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Data Definitions (v2) ---

        const PERIODS = [
            { id: 'current', label: '現行制度' },
            { id: 'r8', label: '令和8年8月〜 (上限額引上げ)' },
            { id: 'r9', label: '令和9年8月〜 (区分細分化)' }
        ];

        const DRUG_DATA = [
            {
                id: 'tezspire',
                name: 'テゼスパイア',
                options: [
                    { label: '1本/月 (12回/年)', cost: 170987, annualCount: 12 },
                    { label: '2本/回 (6回/年)', cost: 341974, annualCount: 6 },
                    { label: '3本/回 (4回/年)', cost: 512961, annualCount: 4 },
                ],
                hasManagementFee: true
            },
            {
                id: 'fasenra',
                name: 'ファセンラ',
                options: [
                    { label: '標準 (6回/年)', cost: 335309, annualCount: 6 },
                ],
                hasManagementFee: false
            },
            {
                id: 'dupixent',
                name: 'デュピクセント',
                options: [
                    { label: '2本/月 (12回/年)', cost: 107318, annualCount: 12 },
                    { label: '4本/回 (6回/年)', cost: 214636, annualCount: 6 },
                    { label: '6本/回 (4回/年)', cost: 321954, annualCount: 4 },
                ],
                hasManagementFee: true
            },
            {
                id: 'nucala',
                name: 'ヌーカラ',
                options: [
                    { label: '1本/月 (12回/年)', cost: 159891, annualCount: 12 },
                    { label: '2本/回 (6回/年)', cost: 319782, annualCount: 6 },
                    { label: '3本/月 (12回/年)', cost: 479673, annualCount: 12 },
                ],
                hasManagementFee: true
            },
            {
                id: 'exidencer',
                name: 'エキシデンサー',
                options: [
                    { label: '1回投与 (2回/年)', cost: 1000000, annualCount: 2 },
                ],
                hasManagementFee: false
            }
        ];

        // Master Data for 3 Patterns
        const MASTER_DATA = {
            current: {
                under70: [
                    { id: 'c-u70-a', label: 'ア (年収1160万円〜)', standardBase: 252600, rate: 0.01, deductionBase: 842000, majorityCap: 140100 },
                    { id: 'c-u70-i', label: 'イ (年収770〜1160万円)', standardBase: 167400, rate: 0.01, deductionBase: 558000, majorityCap: 93000 },
                    { id: 'c-u70-u', label: 'ウ (年収370〜770万円)', standardBase: 80100, rate: 0.01, deductionBase: 267000, majorityCap: 44400 },
                    { id: 'c-u70-e', label: 'エ (年収〜370万円)', standardBase: 57600, rate: 0, deductionBase: 0, majorityCap: 44400 },
                    { id: 'c-u70-o', label: 'オ (住民税非課税)', standardBase: 35400, rate: 0, deductionBase: 0, majorityCap: 24600 },
                ],
                over70: [
                    { id: 'c-o70-3', label: '現役並みⅢ (課税所得690万円〜)', standardBase: 252600, rate: 0.01, deductionBase: 842000, majorityCap: 140100 },
                    { id: 'c-o70-2', label: '現役並みⅡ (課税所得380万円〜)', standardBase: 167400, rate: 0.01, deductionBase: 558000, majorityCap: 93000 },
                    { id: 'c-o70-1', label: '現役並みⅠ (課税所得145万円〜)', standardBase: 80100, rate: 0.01, deductionBase: 267000, majorityCap: 44400 },
                    { id: 'c-o70-gen', label: '一般 (年収156〜約370万円)', standardBase: 57600, rate: 0, deductionBase: 0, majorityCap: 18000 },
                    { id: 'c-o70-low2', label: '低所得Ⅱ (住民税非課税)', standardBase: 24600, rate: 0, deductionBase: 0, majorityCap: 24600 },
                    { id: 'c-o70-low1', label: '低所得Ⅰ (年金80万円以下)', standardBase: 15000, rate: 0, deductionBase: 0, majorityCap: 15000 },
                ]
            },
            r8: {
                under70: [
                    { id: 'r8-u70-a', label: 'ア (年収1160万円〜)', standardBase: 260000, rate: 0.01, deductionBase: 842000, majorityCap: 145000 },
                    { id: 'r8-u70-i', label: 'イ (年収770〜1160万円)', standardBase: 180000, rate: 0.01, deductionBase: 558000, majorityCap: 100000 },
                    { id: 'r8-u70-u', label: 'ウ (年収370〜770万円)', standardBase: 90000, rate: 0.01, deductionBase: 267000, majorityCap: 50000 },
                    { id: 'r8-u70-e', label: 'エ (年収〜370万円)', standardBase: 65000, rate: 0, deductionBase: 0, majorityCap: 50000 },
                    { id: 'r8-u70-o', label: 'オ (住民税非課税)', standardBase: 38000, rate: 0, deductionBase: 0, majorityCap: 26000 },
                ],
                over70: [
                    { id: 'r8-o70-3', label: '現役並みⅢ (課税所得690万円〜)', standardBase: 260000, rate: 0.01, deductionBase: 842000, majorityCap: 145000 },
                    { id: 'r8-o70-2', label: '現役並みⅡ (課税所得380万円〜)', standardBase: 180000, rate: 0.01, deductionBase: 558000, majorityCap: 100000 },
                    { id: 'r8-o70-1', label: '現役並みⅠ (課税所得145万円〜)', standardBase: 90000, rate: 0.01, deductionBase: 267000, majorityCap: 50000 },
                    { id: 'r8-o70-gen', label: '一般 (年収156〜約370万円)', standardBase: 65000, rate: 0, deductionBase: 0, majorityCap: 19000 },
                    { id: 'r8-o70-low2', label: '低所得Ⅱ (住民税非課税)', standardBase: 26000, rate: 0, deductionBase: 0, majorityCap: 26000 },
                    { id: 'r8-o70-low1', label: '低所得Ⅰ (年金80万円以下)', standardBase: 16000, rate: 0, deductionBase: 0, majorityCap: 16000 },
                ]
            },
            r9: {
                under70: [
                    { id: 'r9-u70-a', label: 'ア (年収1160万円〜)', standardBase: 303000, rate: 0.01, deductionBase: 842000, majorityCap: 140100 },
                    { id: 'r9-u70-i', label: 'イ (年収770〜1160万円)', standardBase: 270000, rate: 0.01, deductionBase: 558000, majorityCap: 140100 },
                    { id: 'r9-u70-u3', label: 'ウ-3 (年収600〜770万円)', standardBase: 179000, rate: 0.01, deductionBase: 400000, majorityCap: 93000 },
                    { id: 'r9-u70-u2', label: 'ウ-2 (年収450〜600万円)', standardBase: 120000, rate: 0.01, deductionBase: 300000, majorityCap: 60000 },
                    { id: 'r9-u70-u1', label: 'ウ-1 (年収370〜450万円)', standardBase: 85800, rate: 0.01, deductionBase: 267000, majorityCap: 44400 },
                    { id: 'r9-u70-e', label: 'エ (年収〜370万円)', standardBase: 57600, rate: 0, deductionBase: 0, majorityCap: 44400 },
                    { id: 'r9-u70-o', label: 'オ (住民税非課税)', standardBase: 35400, rate: 0, deductionBase: 0, majorityCap: 24600 },
                ],
                over70: [
                    { id: 'r9-o70-3', label: '現役並み (年収1160万〜)', standardBase: 303000, rate: 0.01, deductionBase: 842000, majorityCap: 140100 },
                    { id: 'r9-o70-2', label: '現役並み (年収770〜1160万)', standardBase: 270000, rate: 0.01, deductionBase: 558000, majorityCap: 140100 },
                    { id: 'r9-o70-g3', label: '一般-3 (年収600〜770万)', standardBase: 179000, rate: 0.01, deductionBase: 400000, majorityCap: 93000 },
                    { id: 'r9-o70-g2', label: '一般-2 (年収450〜600万)', standardBase: 110000, rate: 0.01, deductionBase: 300000, majorityCap: 60000 },
                    { id: 'r9-o70-g1', label: '一般-1 (年収156〜450万)', standardBase: 57600, rate: 0, deductionBase: 0, majorityCap: 44400 },
                    { id: 'r9-o70-low2', label: '低所得Ⅱ (住民税非課税)', standardBase: 24600, rate: 0, deductionBase: 0, majorityCap: 24600 },
                    { id: 'r9-o70-low1', label: '低所得Ⅰ (年金80万円以下)', standardBase: 15000, rate: 0, deductionBase: 0, majorityCap: 15000 },
                ]
            }
        };

        const MANAGEMENT_FEE = 6500;

        // --- Components ---

        const { useState, useEffect, useMemo } = React;
        const Icon = ({ name, className }) => {
            if (typeof lucide === 'undefined' || !lucide.icons) return null;

            // Try PascalCase
            const pascalName = name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');

            let iconNode = lucide.icons[pascalName];

            // Fallback: Check original name or lower case if not found
            if (!iconNode) {
                iconNode = lucide.icons[name] || lucide.icons[name.toLowerCase()];
            }

            if (!iconNode) {
                // If icon not found, avoid crash
                return <span className={className}></span>;
            }

            try {
                const svg = iconNode.toSvg({ class: className });
                return <span style={{ display: 'contents' }} dangerouslySetInnerHTML={{ __html: svg }} />;
            } catch (e) {
                return null;
            }
        };

        function App() {
            // State
            const [period, setPeriod] = useState('current'); // 'current', 'r8', 'r9'
            const [ageGroup, setAgeGroup] = useState('under70'); // 'under70' | 'over70'
            const [incomeBracketId, setIncomeBracketId] = useState('');
            const [isMajority, setIsMajority] = useState(false); // false=初年度, true=2年目以降

            // Current Drug State
            const [currentDrugId, setCurrentDrugId] = useState('nucala');
            const [currentDrugOptionIndex, setCurrentDrugOptionIndex] = useState(2);

            // Target Drug State (After)
            const [targetDrugName, setTargetDrugName] = useState('エキシデンサー');
            const [targetDrugCost, setTargetDrugCost] = useState(1000000); // 10割
            const [targetDrugCount, setTargetDrugCount] = useState(2);
            const [targetHasManagementFee, setTargetHasManagementFee] = useState(true);

            // Helper to get brackets
            const getBrackets = (p, a) => {
                return MASTER_DATA[p][a];
            };

            const activeBrackets = useMemo(() => getBrackets(period, ageGroup), [period, ageGroup]);

            // Set default bracket when period or age changes
            useEffect(() => {
                if (activeBrackets.length > 2) {
                    setIncomeBracketId(activeBrackets[2].id);
                } else {
                    setIncomeBracketId(activeBrackets[0].id);
                }
            }, [period, ageGroup]);



            // Helper to calculation
            const calculateCost = (totalMedicalCost100, countInput, p, age, bracketId, majorityMode) => {
                const count = parseInt(countInput) || 0;
                const brackets = getBrackets(p, age);
                const bracket = brackets.find(b => b.id === bracketId);

                if (!bracket) return {
                    monthlySelfPay: 0,
                    annualSelfPay: 0,
                    isCapped: false,
                    windowPay: 0,
                    totalMedicalCost100: totalMedicalCost100
                };

                // 1. Calculate Standard Ceiling
                let standardCeiling = bracket.standardBase;
                if (bracket.rate > 0) {
                    standardCeiling += (totalMedicalCost100 - bracket.deductionBase) * bracket.rate;
                }

                // 2. Initial Co-pay (Window Pay)
                let coPayRate = 0.3;
                if (age === 'over70') {
                    if (bracket.label.includes('現役並み') || bracket.label.includes('課税所得')) {
                        coPayRate = 0.3;
                    } else {
                        coPayRate = 0.2;
                    }
                }

                const windowPay = totalMedicalCost100 * coPayRate;

                // 3. Determine Monthly Self Pay
                let monthlySelfPay = windowPay;
                let isCapped = false;

                if (windowPay > standardCeiling) {
                    isCapped = true;
                    // Apply Cap
                    if (majorityMode) {
                        monthlySelfPay = bracket.majorityCap;
                    } else {
                        monthlySelfPay = standardCeiling;
                    }
                }

                // --- Annual Calculation Logic (Simulation) ---
                let totalAnnualSelfPay = 0;
                let currentMonthCount = 0;

                // If "2nd Year+" is selected (majorityMode=true), we assume they have already
                // met the criteria in the previous 12 months IF the frequency allows it.
                // e.g. If annualCount >= 3, we start with 3 "high cost" months in history.
                // If annualCount < 3, they never reach majority cap, so start with 0.
                let highCostMonthCount = (majorityMode && count >= 3) ? 3 : 0;

                // Simulate 12 months
                for (let m = 1; m <= 12; m++) {
                    // Determine if drug is administered this month
                    // Simple distribution logic:
                    // 12 times -> Every month (1,2,3...12)
                    // 6 times -> Odd months (1,3,5...11)
                    // 4 times -> 1, 4, 7, 10
                    // 2 times -> 1, 7
                    // 1 time -> 1
                    let isAdministered = false;
                    if (count >= 12) {
                        isAdministered = true;
                    } else if (count === 6) {
                        isAdministered = (m % 2 !== 0);
                    } else if (count === 4) {
                        isAdministered = (m % 3 === 1);
                    } else if (count === 2) {
                        isAdministered = (m === 1 || m === 7);
                    } else if (count === 1) {
                        isAdministered = (m === 1);
                    } else {
                        // Fallback for odd numbers: Spread as evenly as possible?
                        // For now, just assume evenly or simple logic if not standard.
                        // Let's use a step calculation
                        const step = 12 / count;
                        if ((m - 1) % step < 1) isAdministered = true;
                    }

                    if (!isAdministered) {
                        continue;
                    }

                    // Calculate Monthly Cost for this month
                    // 1. Standard Ceiling
                    let currentStandardCeiling = bracket.standardBase;
                    if (bracket.rate > 0) {
                        currentStandardCeiling += (totalMedicalCost100 - bracket.deductionBase) * bracket.rate;
                    }

                    // 2. Initial Co-pay
                    let currentWindowPay = totalMedicalCost100 * coPayRate;

                    // 3. Determine Monthly Self Pay
                    let monthlySelfPay = currentWindowPay;

                    if (currentWindowPay > currentStandardCeiling) {
                        // High Cost Medical Care System Applies

                        // Check for Majority Cap (4th time onwards)
                        // Note: The count increments *after* this month if this month is high cost.
                        // However, for the "4th time", the low price applies TO this 4th time.
                        // So we check: is this going to be the 4th+ high cost month?
                        // BUT, to be a "high cost month", it must exceed the STANDARD ceiling first.

                        // Increment potential count
                        highCostMonthCount++;

                        if (highCostMonthCount >= 4) {
                            monthlySelfPay = bracket.majorityCap;
                        } else {
                            monthlySelfPay = currentStandardCeiling;
                        }
                        isCapped = true; // Flag at least one month was capped
                    }

                    monthlySelfPay = Math.floor(monthlySelfPay);
                    totalAnnualSelfPay += monthlySelfPay;
                }

                // Recalculate a representative "Monthly Self Pay" for display
                // If it varies (e.g. initial year), we might show a range or average?
                // For now, we keep the original variable for compatibility, but maybe update logic.
                // Let's set monthlySelfPay to the *first month's* cost for display consistency,
                // or the "max" cost.
                // User asked for "Annual Total". The monthly display might be confusing if it changes.
                // Let's leave the single month calculation logic above for the "Monthly" display field
                // BUT update the annualSelfPay to be the sum.

                return {
                    monthlySelfPay, // One-time calculation (might be Month 1)
                    annualSelfPay: totalAnnualSelfPay,
                    isCapped,
                    windowPay,
                    totalMedicalCost100
                };
            };

            // Calculate Current (Before)
            const currentDrug = DRUG_DATA.find(d => d.id === currentDrugId);
            const currentOption = currentDrug.options[currentDrugOptionIndex];
            const currentOneTimeCost = currentOption.cost + (currentDrug.hasManagementFee ? MANAGEMENT_FEE : 0);

            const currentResult = calculateCost(
                currentOneTimeCost,
                currentOption.annualCount,
                period,
                ageGroup,
                incomeBracketId,
                isMajority
            );

            // Calculate Target (After)
            const isTargetManagementFeeApplicable = ['ヌーカラ', 'デュピクセント', 'テゼスパイア'].some(d => targetDrugName.includes(d));
            const targetOneTimeCost = parseInt(targetDrugCost) + ((isTargetManagementFeeApplicable && targetHasManagementFee) ? MANAGEMENT_FEE : 0);
            const targetResult = calculateCost(
                targetOneTimeCost,
                targetDrugCount,
                period,
                ageGroup,
                incomeBracketId,
                isMajority
            );

            const annualizedDiff = currentResult.annualSelfPay - targetResult.annualSelfPay;



            return (
                <div className="min-h-screen p-4 md:p-8 flex items-center justify-center">
                    <div className="w-full max-w-7xl bg-white rounded-3xl chic-shadow overflow-hidden border border-slate-200">
                        {/* Header */}
                        <header className="bg-slate-800 p-6 text-white flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="p-2 bg-slate-700/50 rounded-xl">
                                    <Icon name="calculator" className="w-6 h-6 text-slate-100" />
                                </div>
                                <h1 className="text-xl font-medium tracking-wide">治療費シミュレーター</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                {period !== 'current' && (
                                    <div className="px-4 py-1.5 rounded-full text-xs font-semibold bg-slate-700 text-slate-200 border border-slate-600 tracking-wider">
                                        {PERIODS.find(p => p.id === period).label} 試算中
                                    </div>
                                )}
                            </div>
                        </header>

                        <div className="grid md:grid-cols-12 gap-0">
                            {/* LEFT COLUMN: Inputs */}
                            <div className="md:col-span-4 lg:col-span-5 bg-slate-50 p-6 md:p-8 border-r border-slate-200 overflow-y-auto max-h-[calc(100vh-100px)]">
                                <h2 className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                                    <Icon name="settings" className="w-4 h-4" />
                                    Configuration
                                </h2>

                                <div className="space-y-8">

                                    {/* System Period Selection */}
                                    <section>
                                        <h3 className="text-sm font-semibold text-slate-700 mb-3">制度適用時期</h3>
                                        <div className="space-y-2">
                                            {PERIODS.map(p => (
                                                <button key={p.id}
                                                    onClick={() => setPeriod(p.id)}
                                                    className={`w-full text-left px-4 py-3 rounded-xl border transition-all duration-200 flex items-center justify-between group ${period === p.id
                                                        ? 'bg-slate-800 border-slate-800 text-white shadow-md'
                                                        : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300 hover:bg-slate-50'
                                                        }`}>
                                                    <span className="text-sm font-medium">{p.label}</span>
                                                    {period === p.id && <Icon name="check" className="w-4 h-4 text-emerald-400" />}
                                                </button>
                                            ))}
                                        </div>
                                    </section>

                                    {/* Patient Info */}
                                    <section>
                                        <h3 className="text-sm font-semibold text-slate-700 mb-3">患者情報</h3>
                                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-2">年齢区分</label>
                                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                                    <button onClick={() => setAgeGroup('under70')}
                                                        className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${ageGroup === 'under70' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                                        69歳以下
                                                    </button>
                                                    <button onClick={() => setAgeGroup('over70')}
                                                        className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${ageGroup === 'over70' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                                        70歳以上
                                                    </button>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-2">所得区分</label>
                                                <select className="w-full text-sm p-2.5 bg-slate-50 border-slate-200 border rounded-lg focus:ring-2 focus:ring-slate-200 focus:border-slate-400 outline-none transition-all text-slate-700"
                                                    value={incomeBracketId}
                                                    onChange={(e) => setIncomeBracketId(e.target.value)}>
                                                    {activeBrackets.map(b => (
                                                        <option key={b.id} value={b.id}>{b.label}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-2">適用期間</label>
                                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                                    <button onClick={() => setIsMajority(false)}
                                                        className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${!isMajority ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                                        導入初年度
                                                    </button>
                                                    <button onClick={() => setIsMajority(true)}
                                                        className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${isMajority ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                                        2年目以降
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    {/* Current Drug */}
                                    <section>
                                        <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3 text-xs">現在の薬剤 (Before)</h3>
                                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-2">薬剤名</label>
                                                <select className="w-full text-sm p-2.5 bg-slate-50 border-slate-200 border rounded-lg focus:ring-2 focus:ring-slate-200 text-slate-700 outline-none"
                                                    value={currentDrugId}
                                                    onChange={(e) => {
                                                        const newId = e.target.value;
                                                        setCurrentDrugId(newId);
                                                        setCurrentDrugOptionIndex(0); // Reset option
                                                    }}>
                                                    {DRUG_DATA.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                                </select>
                                            </div>
                                            <div className="grid grid-cols-1 gap-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-500 mb-2">処方量/頻度</label>
                                                    <select className="w-full text-sm p-2.5 bg-slate-50 border-slate-200 border rounded-lg focus:ring-2 focus:ring-slate-200 text-slate-700 outline-none"
                                                        value={currentDrugOptionIndex}
                                                        onChange={(e) => setCurrentDrugOptionIndex(parseInt(e.target.value))}>
                                                        {currentDrug.options.map((opt, idx) => (
                                                            <option key={idx} value={idx}>{opt.label}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    {/* Target Drug */}
                                    <section>
                                        <div className="flex items-center justify-between mb-3">
                                            <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wider text-xs">切替後の薬剤 (After)</h3>
                                            <span className="bg-emerald-100 text-emerald-800 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wide">New</span>
                                        </div>
                                        <div className="bg-emerald-50/50 p-5 rounded-xl border border-emerald-100 space-y-4">
                                            <div>
                                                <label className="block text-xs font-medium text-emerald-700/70 mb-2">薬剤名</label>
                                                <input type="text" className="w-full text-sm p-2.5 bg-white border-emerald-200 border rounded-lg focus:ring-2 focus:ring-emerald-100 text-emerald-900 outline-none transition-all placeholder-emerald-300"
                                                    value={targetDrugName}
                                                    onChange={(e) => setTargetDrugName(e.target.value)} />
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-emerald-700/70 mb-2">薬剤費(10割)</label>
                                                    <input type="number" className="w-full text-sm p-2.5 bg-white border-emerald-200 border rounded-lg focus:ring-2 focus:ring-emerald-100 text-right text-emerald-900 outline-none"
                                                        value={targetDrugCost}
                                                        onChange={(e) => setTargetDrugCost(e.target.value)} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-emerald-700/70 mb-2">年間回数</label>
                                                    <input type="number" className="w-full text-sm p-2.5 bg-white border-emerald-200 border rounded-lg focus:ring-2 focus:ring-emerald-100 text-right text-emerald-900 outline-none"
                                                        value={targetDrugCount}
                                                        onChange={(e) => setTargetDrugCount(parseInt(e.target.value) || 0)} />
                                                </div>
                                            </div>
                                            {['ヌーカラ', 'デュピクセント', 'テゼスパイア'].some(d => targetDrugName.includes(d)) && (
                                                <div className="flex items-center">
                                                    <input type="checkbox" id="mgmtFee" className="w-4 h-4 text-emerald-600 rounded focus:ring-emerald-500 border-gray-300"
                                                        checked={targetHasManagementFee}
                                                        onChange={(e) => setTargetHasManagementFee(e.target.checked)} />
                                                    <label htmlFor="mgmtFee" className="ml-2 text-xs font-medium text-emerald-800">
                                                        在宅自己注射指導管理料を含める (+6,500円)
                                                    </label>
                                                </div>
                                            )}
                                        </div>
                                    </section>
                                </div>
                            </div>

                            {/* RIGHT COLUMN: Results */}
                            <div className="md:col-span-8 lg:col-span-7 p-6 md:p-10 bg-white">
                                <h2 className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-8 flex items-center gap-2">
                                    <Icon name="wallet" className="w-4 h-4" />
                                    Simulation Result
                                </h2>

                                {/* Reform Notice */}
                                {period !== 'current' && (
                                    <div className="mb-8 bg-slate-50 border border-slate-200 p-4 rounded-lg flex items-start gap-3">
                                        <Icon name="info" className="w-5 h-5 text-slate-400 mt-0.5" />
                                        <div className="text-sm text-slate-600 leading-relaxed">
                                            <span className="font-semibold text-slate-800">{PERIODS.find(p => p.id === period).label}</span> に基づく試算結果を表示しています。
                                            <br />
                                            {period === 'r9' && "※所得区分の細分化により、一部の所得層で上限額が変動しています。"}
                                            {period === 'r8' && "※定額負担金の引き上げ案を反映しています。"}
                                        </div>
                                    </div>
                                )}

                                {/* Hero Result */}
                                <div className={`relative p-8 rounded-2xl mb-10 transition-all duration-300 ${annualizedDiff > 0 ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-800'}`}>
                                    <div className="flex flex-col md:flex-row items-end md:items-center justify-between gap-6">
                                        <div>
                                            <p className={`text-sm font-medium mb-2 ${annualizedDiff > 0 ? 'text-slate-300' : 'text-slate-500'}`}>年間自己負担額の差額</p>
                                            <div className="flex items-baseline gap-1">
                                                <span className="text-5xl md:text-6xl font-light tracking-tighter">
                                                    {Math.abs(annualizedDiff).toLocaleString()}
                                                </span>
                                                <span className="text-lg font-light opacity-60">円</span>
                                            </div>
                                        </div>

                                        <div className={`px-5 py-2 rounded-full text-sm font-medium flex items-center gap-2 ${annualizedDiff > 0 ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30' : 'bg-rose-500/10 text-rose-600 border border-rose-500/20'}`}>
                                            {annualizedDiff > 0 ? (
                                                <>
                                                    <Icon name="trending-down" className="w-4 h-4" />
                                                    {Math.abs(annualizedDiff).toLocaleString()}円 安くなります
                                                </>
                                            ) : (
                                                <>
                                                    <Icon name="trending-up" className="w-4 h-4" />
                                                    {Math.abs(annualizedDiff).toLocaleString()}円 高くなります
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Comparison Table */}
                                <div className="mb-8">
                                    <div className="grid grid-cols-3 text-xs uppercase tracking-wider font-semibold text-slate-400 border-b border-slate-100 pb-2 mb-4">
                                        <div>Item</div>
                                        <div className="text-center">Current</div>
                                        <div className="text-center text-emerald-600">New</div>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="grid grid-cols-3 items-center py-4 border-b border-slate-50 hover:bg-slate-50/50 transition-colors rounded-lg px-2">
                                            <div className="font-medium text-slate-700">年間自己負担額</div>
                                            <div className="text-center text-xl font-light text-slate-600">{currentResult.annualSelfPay.toLocaleString()}円</div>
                                            <div className="text-center text-xl font-bold text-emerald-600">{targetResult.annualSelfPay.toLocaleString()}円</div>
                                        </div>

                                        <div className="grid grid-cols-3 items-center py-4 border-b border-slate-50 hover:bg-slate-50/50 transition-colors rounded-lg px-2">
                                            <div>
                                                <div className="text-sm font-medium text-slate-600">1回あたり自己負担</div>
                                                <div className="text-xs text-slate-400 mt-0.5 scale-90 origin-left">※高額療養費適用後</div>
                                            </div>
                                            <div className="text-center text-sm font-medium text-slate-500">{currentResult.monthlySelfPay.toLocaleString()}円</div>
                                            <div className="text-center text-sm font-medium text-slate-500">{targetResult.monthlySelfPay.toLocaleString()}円</div>
                                        </div>

                                        <div className="grid grid-cols-3 items-center py-4 border-b border-slate-50 hover:bg-slate-50/50 transition-colors rounded-lg px-2">
                                            <div className="text-sm font-medium text-slate-600">制度適用</div>
                                            <div className="text-center">
                                                {currentResult.isCapped ? (
                                                    <span className="px-2 py-1 rounded text-[10px] font-bold bg-slate-100 text-slate-600 border border-slate-200">
                                                        上限適用
                                                    </span>
                                                ) : (
                                                    <span className="text-xs text-slate-400">窓口負担のみ</span>
                                                )}
                                            </div>
                                            <div className="text-center">
                                                {targetResult.isCapped ? (
                                                    <span className="px-2 py-1 rounded text-[10px] font-bold bg-emerald-50 text-emerald-600 border border-emerald-100">
                                                        上限適用
                                                    </span>
                                                ) : (
                                                    <span className="text-xs text-slate-400">窓口負担のみ</span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-slate-50 rounded-lg p-6 border border-slate-100 text-xs text-slate-500 leading-relaxed italic">
                                    <p className="mb-2 font-semibold not-italic">免責事項</p>
                                    この試算は概算です。実際の窓口負担額は、他の医療機関での受診状況、入院・外来の区別、世帯合算、自治体の独自助成などにより異なる場合があります。
                                    正確な金額はご加入の健康保険組合または医療機関の窓口でご確認ください。
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>